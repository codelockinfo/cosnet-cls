{% liquid
  assign enable_rtl = settings.rtl
  assign iso_code = request.locale.iso_code
  assign lis_language_rtl = settings.language_rtl
  if lis_language_rtl != blank
    if lis_language_rtl contains iso_code
      assign enable_rtl = true
    else
      assign enable_rtl = false
    endif
  endif
%}

<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">
    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}
    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>
    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}
    {% render 'meta-tags' %}
    {{ content_for_header }}
    {{ 'critical.css' | asset_url | stylesheet_tag }}
    {{ 'animation.css' | asset_url | stylesheet_tag }}
    {% if enable_rtl %}{{ 'rtl.css' | asset_url | stylesheet_tag: preload: true }}{% endif %}
    {{ 'product-card.css' | asset_url | stylesheet_tag }}
    {{ 'swiper-bundle.min.css' | asset_url | stylesheet_tag }}
    {{ 'judgeme-reviews.css' | asset_url | stylesheet_tag }}
    {% render 'font-variables' %}
    {% if request.design_mode %}
      {{ 'design-mode.css' | asset_url | stylesheet_tag: preload: true }}
    {% endif %}
    {% style %}
      {% for scheme in settings.color_schemes -%}
        {% # theme-check-disable UndefinedObject %}
        {% assign scheme_classes = scheme_classes | append: ', .color-' | append: scheme.id %}
        {% # theme-check-disable UndefinedObject %}
        {% if forloop.index == 1 -%}
          :root,
        {%- endif %}
        .color-{{ scheme.id }} {
          --color-background: {{ scheme.settings.background }};
          {% if scheme.settings.background_gradient != empty %}
          --gradient-background: {{ scheme.settings.background_gradient }};
          {% else %}
          --gradient-background: {{ scheme.settings.background }};
          {% endif %}
          --color-primary: {{ scheme.settings.primary_color }};
          --color-primary-rgb: {{ scheme.settings.primary_color.red }}, {{ scheme.settings.primary_color.green }}, {{ scheme.settings.primary_color.blue }};
          --color-text: {{ scheme.settings.text_color }};
          --color-text-rgb: {{ scheme.settings.text_color.red }}, {{ scheme.settings.text_color.green }}, {{ scheme.settings.text_color.blue }};
          --color-heading: {{ scheme.settings.heading_color }};
          --color-heading-rgb:{{ scheme.settings.heading_color.red }}, {{ scheme.settings.heading_color.green }}, {{ scheme.settings.heading_color.blue }};
          --color-link: {{ scheme.settings.text_color }};
          --color-link-hover: {{ scheme.settings.primary_color }};
          --color-border: {{ scheme.settings.border_color }};
          /* Button primary */
          --btn-primary-color: {{ scheme.settings.btn_primary_color }};
          --btn-primary-hover-color: {{ scheme.settings.btn_primary_hover_color }};
          --btn-primary-bg-color: {{ scheme.settings.btn_primary_background }};
          --btn-primary-hover-bg-color: {{ scheme.settings.btn_primary_hover_background }};
          /* Button outline */
          --btn-outline-bg-color: {{ scheme.settings.btn_outline_background }};
          --btn-outline-color: {{ scheme.settings.btn_outline_color }};
          --btn-outline-border-color: {{ scheme.settings.btn_outline_border_color }};
          /* Button link */
          --btn-link-color: {{ scheme.settings.button_link_color }};
          --btn-link-hover-color: {{ scheme.settings.button_link_hover_color }};
          --input-color: var(--color-text);
          --input-placeholder-color: rgba(var(--color-heading-rgb), 0.55);
          --input-bg: rgba({{ scheme.settings.background.red }}, {{ scheme.settings.background.green }}, {{ scheme.settings.background.blue }}, 0.6);
        }
      {% endfor %}
      {{ scheme_classes | prepend: 'body' }} {
        color: var(--color-text);
        background-color: var(--color-background);
      }
      :root {
        --border-color-base: {% if settings.dark_mode %}var(--color-border){% else %}#e5e5e5{% endif %};
        --light-grey-color:{% if settings.dark_mode %}#1a1a1a{% else %}#f5f5f5{% endif %};
        --bg-color-white:{% if settings.dark_mode %}var(--gradient-background){% else %}#ffffff{% endif %};
        --show-overlay-bg:{% if settings.dark_mode %}rgba(156, 156, 156, 0.7){% else %}rgba(255, 255, 255, 0.9){% endif %};
        --white-gradient:{% if settings.dark_mode %}linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #000 100%){% else %}linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #fff 100%){% endif %};
        --icon-select:{% if settings.dark_mode %}
          url("data:image/svg+xml,%3Csvg width='10' height='5' viewBox='0 0 10 5' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.08984 1.32227L4.58984 4.82227C4.69922 4.94076 4.83594 5 5 5C5.16406 5 5.30078 4.94076 5.41016 4.82227L8.91016 1.32227C9.02865 1.21289 9.08789 1.08073 9.08789 0.925781C9.08789 0.761719 9.02865 0.620443 8.91016 0.501953C8.80078 0.392578 8.66406 0.337891 8.5 0.337891C8.33594 0.337891 8.19922 0.392578 8.08984 0.501953L5 3.5918L1.91016 0.501953C1.80078 0.392578 1.66406 0.337891 1.5 0.337891C1.33594 0.337891 1.19922 0.392578 1.08984 0.501953C0.971354 0.620443 0.912109 0.761719 0.912109 0.925781C0.912109 1.08073 0.971354 1.21289 1.08984 1.32227Z' fill='%23ffffff'/%3E%3C/svg%3E")
          {% else %}
          url("data:image/svg+xml,%3Csvg width='10' height='5' viewBox='0 0 10 5' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.08984 1.32227L4.58984 4.82227C4.69922 4.94076 4.83594 5 5 5C5.16406 5 5.30078 4.94076 5.41016 4.82227L8.91016 1.32227C9.02865 1.21289 9.08789 1.08073 9.08789 0.925781C9.08789 0.761719 9.02865 0.620443 8.91016 0.501953C8.80078 0.392578 8.66406 0.337891 8.5 0.337891C8.33594 0.337891 8.19922 0.392578 8.08984 0.501953L5 3.5918L1.91016 0.501953C1.80078 0.392578 1.66406 0.337891 1.5 0.337891C1.33594 0.337891 1.19922 0.392578 1.08984 0.501953C0.971354 0.620443 0.912109 0.761719 0.912109 0.925781C0.912109 1.08073 0.971354 1.21289 1.08984 1.32227Z' fill='%23111111'/%3E%3C/svg%3E")
          {% endif %};
         --pswp-bg: {% if settings.dark_mode %}var(--gradient-background){% else %}#ffffff{% endif %};
        {% if settings.enable_rounded %} --rounded-radius: {{ settings.rounded_corner }}px;{% endif %}
        --logo-width: {{ settings.mobile_logo_width }}px;
        --body-font-size: {{ settings.body_font_size }}px;
        --body-line-height: 1.714;
        --body-weight: {{ settings.body_font_weight }};
        --heading-font-scale: {{ settings.heading_font_scale | divided_by: 100.0 }};
        --heading-text-transform: {{ settings.heading_text_transform }};
        --heading-letter-spacing: {% if settings.heading_letter_spacing == 'negative' %}-0.034em{% else %}{{ settings.heading_letter_spacing }}{% endif %};
        --heading-weight: {{ settings.heading_font_weight }};
        --subheading-weight: {{ settings.subheading_font_weight }};
        --medium-font-weight: {% if settings.menu_font == 'body_font' %}{{ settings.body_font.family }}{% else %}{{ settings.heading_font.family }}{% endif %}, {{ settings.body_font.fallback_families }};
        --btn-text-transform: {{ settings.btn_text_transform }};
        --btn-radius: {{ settings.button_radius }}px;
        --btn-font-size: var(--body-font-size, 1.4rem);
        --btn-padding-y: 1rem;
        --btn-padding-x: 3rem;
        --btn-letter-spacing:  {% if settings.heading_letter_spacing == 'negative' %}calc(var(--heading-letter-spacing) + 0.01em){% else %}calc(var(--heading-letter-spacing) - 0.01em){% endif %};
        --input-height: 5rem;
        {% if settings.rounded_corner > 1 %}
        --input-padding: 1rem 2rem;
        {% else %}
        --input-padding: 1rem 1.5rem;
        {% endif %}
        --inputs-border-width: 1px;
        --input-color: var(--color-text);
        --input-border-radius: var(--btn-radius);
        --input-font-size:  {% if settings.body_font_size < 16 %}16px{% else %}{{ settings.body_font_size }}{% endif %};
        --input-placeholder-color: rgba(var(--color-heading-rgb), 0.6);
        --page-width: {{ settings.page_width }}px;
        --page-width-value: {{ settings.page_width }};
        --fluid-container-width: {{ settings.fluid_container_width }}px;
        --fluid-container-width-value: {{ settings.fluid_container_width }}px;
        --color-white: {% if settings.dark_mode %}#111111{% else %}#ffffff{% endif %};
        --color-dark: {% if settings.dark_mode %}#ffffff{% else %}#111111{% endif %};
        --h0-size: calc(var(--heading-font-scale) * 4.8rem);
        --h1-size: calc(var(--heading-font-scale) * 4rem);
        --h2-size: calc(var(--heading-font-scale) * 3.6rem);
        --h3-size: calc(var(--heading-font-scale) * 3rem);
        --h4-size:  calc(var(--heading-font-scale) * 2.4rem);
        --h5-size: calc(var(--heading-font-scale) * 1.8rem);
        --h6-size: calc(var(--heading-font-scale) * 1.6rem);
        --transition: all 0.4s;
        --duration-short: 0.3s;
        --duration-long: 0.5s;
        --transition-popup: all .4s cubic-bezier(.7, 0, .2, 1);
        --zoom-transform: scale(1.05);
        --overlay-bg:{% if settings.dark_mode %}rgba(156, 156, 156, 0.5){% else %}rgba(0, 0, 0, 0.60){% endif %};
        --grey-color:{% if settings.dark_mode %}#1a1a1a{% else %}#f5f5f5{% endif %};
        --section-spacing: {{ settings.space_mobile }}px;
        --bs-gutter-x: 1.5rem;
        --shadow: {% if settings.dark_mode %}5px 0px 30px 0px rgba(255, 255, 255, 0.08){% else %}5px 0px 30px 0px rgba(0, 0, 0, 0.08){% endif %};
        /* Badge color */
        --bages-radius: {{ settings.badges_rounded_corner }}px;
        --bages-sale-color: {{ settings.sale_color }};
        --bages-sale-bg-color: {{ settings.sale_background }};
        --bages-new-color: {{ settings.new_color }};
        --bages-new-bg-color: {{ settings.new_background }};
        --bages-pre-order-color: {{ settings.pre_order_color }};
        --bages-pre-order-bg-color: {{ settings.pre_order_background }};
        --bages-sold-out-color: {{ settings.sold_out_color }};
        --bages-sold-out-bg-color: {{ settings.sold_out_background }};
        --bages-custom-color: {{ settings.custom_badge_color }};
        --bages-custom-bg-color: {{ settings.custom_badge_background }};
        --btn-action-color:{{settings.custom_action_color }};
        --btn-action-bg-color:{{settings.custom_action_background }};
        --btn-action-hover-color:{{settings.custom_action_hover_color }};
        --btn-action-hover-bg-color:{{settings.custom_action_hover_background }};
        --responsive-rate: ((100vw - 575px) / (1600 - 575));
      }
      @media (min-width: 768px) {
        :root{
          --section-spacing: {{ settings.spacing_desktop }}px;
          --logo-width: {{ settings.logo_width }}px;
          --btn-padding-y: 1.5rem;
           --btn-padding-x: 5.5rem;
           --input-font-size: calc(var(--body-font-size) - 1px);
        }
      }
    {% endstyle %}
    <link rel="stylesheet" href="{{ 'theme.css' | asset_url }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ 'theme.css' | asset_url }}"></noscript>
    <link rel="stylesheet" href="{{ 'popup.css' | asset_url }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ 'popup.css' | asset_url }}"></noscript>
    <script src="{{ 'motion.min.js' | asset_url }}" type="module" defer="defer"></script>
    <script src="{{ 'swiper-bundle.min.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'global.js' | asset_url }}" defer="defer"></script>
    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }
    </script>
  </head>
  <body
    class="{% unless request.design_mode %}is-frontend{% endunless %} gradient{% if settings.rounded_corner > 1 and settings.enable_rounded %} rounded-style{% endif %}{% if settings.action_after_add_cart == 'show_popup' %} minicart_type-popup{% endif %}{% if enable_rtl %} rtl{% endif %} {% if request.page_type == 'cart'%}template-cart{% endif %} {{ request.page_type }}"
  >
    {%- liquid
      render 'preload-page'
      sections 'header-group'
    -%}
    <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>
    {% sections 'footer-group' %}
    {%- liquid
      sections 'overlay-group'
      section 'mobile-navigation-bar'
      section 'product-quickview'
      section 'custom-colors'
      section 'fake-order'
    -%}
    {% section 'top-search' %}
    {%- render 'minicart' -%}
    {%- render 'scripts-tag' -%}
    {%- render 'sprite-svg' -%}
    {%- render 'content-bottom' -%}
    
    {%- comment -%} Discount Coupons JavaScript (Global) {%- endcomment -%}
    <script>
      function copyCouponCode(element) {
        const codeElement = element.querySelector('.coupon-code');
        if (!codeElement) return;

        const code = codeElement.getAttribute('data-code') || codeElement.textContent.trim();
        if (!code || code === 'At checkout') return;

        navigator.clipboard.writeText(code).then(function() {
          const originalText = codeElement.textContent;
          codeElement.textContent = 'Copied!';
          codeElement.style.color = 'var(--color-primary, #000)';
          setTimeout(function() {
            codeElement.textContent = originalText;
            codeElement.style.color = '#333';
          }, 2000);
        }).catch(function(err) {
          console.error('Failed to copy coupon code:', err);
        });
      }

      /**
       * Get the quantity of a specific product in the cart
       * @param {number} productId - The product ID to check
       * @returns {Promise<object>} - Promise that resolves to {quantity: number, title: string}
       */
      async function getProductQuantityFromCart(productId) {
        try {
          const response = await fetch('/cart.json');
          const cart = await response.json();

          if (!cart.items || cart.items.length === 0) {
            return { quantity: 0, title: null };
          }

          // Find all cart items with matching product_id and sum their quantities
          let totalQuantity = 0;
          let productTitle = null;

          cart.items.forEach(function(item) {
            // Compare as numbers to handle string/number mismatch
            if (parseInt(item.product_id) === parseInt(productId)) {
              totalQuantity += item.quantity;
              // Get product title from first matching item
              if (!productTitle) {
                productTitle = item.product_title;
              }
            }
          });

          return { quantity: totalQuantity, title: productTitle };
        } catch (error) {
          console.error('Error fetching cart:', error);
          return { quantity: 0, title: null };
        }
      }

      /**
       * Set cookie helper function
       */
      function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
      }

      /**
       * Get cart total price
       */
      async function getCartTotalPrice() {
        try {
          const response = await fetch('/cart.json');
          const cart = await response.json();
          return cart.total_price / 100; // Convert from cents
        } catch (error) {
          console.error('Error fetching cart total:', error);
          return 0;
        }
      }

      /**
       * Parse discount type text to extract condition
       * Supports multiple patterns: "Buy 1 get 1", "Buy 100 rs and get 10%", "Amount off products"
       * Returns: { type: 'quantity' | 'price' | null, value: number, condition: string }
       */
      function parseDiscountTypeToCondition(discountType) {
        if (!discountType || discountType.trim() === '') {
          return null; // No condition, show always
        }

        const text = discountType.trim().toLowerCase();
        
        // Pattern 1: Price-based conditions
        // "Buy 100 rs", "Buy ₹100", "Spend 500 rs", "Minimum 1000 amount"
        const pricePatterns = [
          /buy\s+[₹₹]?\s*(\d+)\s*(rs|rupees?|amount)/i,  // "Buy 100 rs", "Buy ₹100"
          /spend\s+[₹₹]?\s*(\d+)\s*(rs|rupees?)/i,        // "Spend 500 rs"
          /minimum\s+[₹₹]?\s*(\d+)\s*(rs|rupees?|amount)/i, // "Minimum 1000 amount"
          /purchase\s+[₹₹]?\s*(\d+)\s*(rs|rupees?)/i      // "Purchase 200 rs"
        ];
        
        for (let pattern of pricePatterns) {
          const match = text.match(pattern);
          if (match) {
            const minPrice = parseInt(match[1]);
            return {
              type: 'price',
              value: minPrice,
              condition: minPrice + '+',
              originalText: discountType
            };
          }
        }
        
        // Pattern 2: Quantity-based conditions - "Buy X Get Y Free"
        // "Buy 1 get 1 free" → requires minimum 2 items in cart (1 + 1 = 2)
        // "Buy 4 get 1 free" → requires minimum 5 items in cart (4 + 1 = 5)
        // "Buy 7 get 1 free" → requires minimum 8 items in cart (7 + 1 = 8)
        // Minimum should be 1 more than the "Buy X" number (X + Y)
        // No maximum limit - users can add more items
        const buyGetFreeMatch = text.match(/buy\s+(\d+)\s+get\s+(\d+)\s*(free)?/i);
        if (buyGetFreeMatch) {
          const buyQuantity = parseInt(buyGetFreeMatch[1]); // The "Buy X" number
          const freeQuantity = parseInt(buyGetFreeMatch[2]); // The "Get Y" number
          const minQuantity = buyQuantity + freeQuantity; // Minimum required (X + Y)
          return {
            type: 'quantity',
            value: minQuantity, // Minimum quantity needed (X + Y)
            condition: minQuantity + '+', // At least (X + Y) items, no maximum
            originalText: discountType
          };
        }
        
        // Pattern 2b: Other quantity-based conditions
        // "Buy 2 items", "Minimum 5 quantity"
        const quantityPatterns = [
          /buy\s+(\d+)\s+(items?|quantity)/i,  // "Buy 3 items"
          /minimum\s+(\d+)\s+(quantity|items?|qty)/i, // "Minimum 5 quantity"
          /purchase\s+(\d+)\s+(items?|quantity)/i   // "Purchase 2 items"
        ];
        
        for (let pattern of quantityPatterns) {
          const match = text.match(pattern);
          if (match) {
            const minQuantity = parseInt(match[1]);
            return {
              type: 'quantity',
              value: minQuantity,
              condition: minQuantity + '+',
              originalText: discountType
            };
          }
        }
        
        // Pattern 3: Simple "Buy X" (assume quantity if no "rs" mentioned)
        const simpleBuyMatch = text.match(/^buy\s+(\d+)(?!\s*(rs|rupees?|amount|₹))/i);
        if (simpleBuyMatch) {
          const minQuantity = parseInt(simpleBuyMatch[1]);
          return {
            type: 'quantity',
            value: minQuantity,
            condition: minQuantity + '+',
            originalText: discountType
          };
        }
        
        // No pattern found - show always (e.g., "Amount off products")
        return null;
      }

      /**
       * Check if cart matches discount condition
       * Handles quantity-based, price-based, and no-condition types
       */
      async function matchesDiscountCondition(discountType, productId) {
        if (!discountType || discountType.trim() === '') {
          return true; // Show if no condition
        }

        // Parse discount type to get condition
        const parsedCondition = parseDiscountTypeToCondition(discountType);
        
        if (!parsedCondition) {
          return true; // No pattern found, show always
        }

        if (parsedCondition.type === 'quantity') {
          // Quantity-based: Check cart quantity for this specific product
          // "Buy X Get Y Free" means: cart quantity must be >= (X + Y)
          // Example: "Buy 1 Get 1 Free" → requires quantity >= 2 (1 + 1 = 2)
          // Example: "Buy 4 Get 1 Free" → requires quantity >= 5 (4 + 1 = 5)
          // Example: "Buy 7 Get 1 Free" → requires quantity >= 8 (7 + 1 = 8)
          const cartData = await getProductQuantityFromCart(productId);
          
          // Minimum should be X + Y (Buy X + Get Y)
          const matches = cartData.quantity >= parsedCondition.value;
          return matches;
        }
        
        if (parsedCondition.type === 'price') {
          // Price-based: Check cart total price (all items)
          const cartTotal = await getCartTotalPrice();
          const matches = cartTotal >= parsedCondition.value;
          return matches;
        }

        return true;
      }

      /**
       * Check coupons for all products in cart (works on all pages)
       * Gets all products from cart and checks their coupons
       */
      window.checkAllCartProductsCoupons = async function checkAllCartProductsCoupons() {
        try {
          const response = await fetch('/cart.json');
          const cart = await response.json();

          if (!cart.items || cart.items.length === 0) {
            // No items in cart, clear cookie
            setCookie('discount_code', '', -1);
            return;
          }

          const cartTotal = cart.total_price / 100;

          let allMatchingCoupons = [];
          let bestCoupon = null;
          let highestValue = -1;

          // Function to fetch product metafields from product page HTML
          async function fetchProductMetafields(productId, productUrl) {
            try {
              let productHandle = null;
              
              // Extract handle from product URL (format: /products/product-handle)
              if (productUrl) {
                const urlMatch = productUrl.match(/\/products\/([^\/\?]+)/);
                if (urlMatch && urlMatch[1]) {
                  productHandle = urlMatch[1];
                }
              }
              
              // If handle not found from URL, try to get from DOM (if cart item is rendered)
              if (!productHandle) {
                const cartItemElement = document.querySelector(`[product-handle][data-product-id="${productId}"], [product-handle]`);
                if (cartItemElement) {
                  productHandle = cartItemElement.getAttribute('product-handle');
                }
              }
              
              if (!productHandle) {
                return null;
              }
              
              // First, check if discount section exists in current page DOM (faster)
              const existingDiscountSection = document.querySelector(`.product-discount-coupons[data-product-id="${productId}"]`);
              if (existingDiscountSection) {
                const couponCards = existingDiscountSection.querySelectorAll('.discount-coupon-card[data-discount-type]');
                if (couponCards.length > 0) {
                  const discountCodes = [];
                  const discountTypes = [];
                  
                  couponCards.forEach(function(card) {
                    const code = card.getAttribute('data-discount-code');
                    const type = card.getAttribute('data-discount-type');
                    if (code && code !== 'At checkout') {
                      discountCodes.push(code);
                      discountTypes.push(type || '');
                    }
                  });
                  
                  if (discountCodes.length > 0) {
                    return {
                      discount: discountCodes,
                      discount_type: discountTypes
                    };
                  }
                }
              }
              
              // If not in DOM, fetch product page HTML to extract metafields
              const response = await fetch(`/products/${productHandle}`);
              if (!response.ok) {
                return null;
              }
              
              const html = await response.text();
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              
              // Look for discount section with product ID
              const discountSection = doc.querySelector(`.product-discount-coupons[data-product-id="${productId}"]`);
              if (!discountSection) {
                return null;
              }
              
              // Extract coupon cards and their data
              const couponCards = discountSection.querySelectorAll('.discount-coupon-card[data-discount-type]');
              if (couponCards.length === 0) {
                return null;
              }
              
              // Extract discount codes and types
              const discountCodes = [];
              const discountTypes = [];
              
              couponCards.forEach(function(card) {
                const code = card.getAttribute('data-discount-code');
                const type = card.getAttribute('data-discount-type');
                if (code && code !== 'At checkout') {
                  discountCodes.push(code);
                  discountTypes.push(type || '');
                }
              });
              
              if (discountCodes.length === 0) {
                return null;
              }
              
              return {
                discount: discountCodes,
                discount_type: discountTypes
              };
            } catch (error) {
              console.error('Error fetching product metafields:', error);
              return null;
            }
          }
          
          // Get unique product IDs from cart with their URLs
          const productMap = new Map();
          cart.items.forEach(function(item) {
            const productId = parseInt(item.product_id);
            if (!productId || isNaN(productId)) return;
            
            if (!productMap.has(productId)) {
              productMap.set(productId, {
                id: productId,
                url: item.url || item.product_url || '',
                title: item.product_title || item.title || ''
              });
            }
          });
          
          // Check each unique product in cart
          for (let [productId, productInfo] of productMap) {
            // Get product quantity
            let productQuantity = 0;
            cart.items.forEach(function(cartItem) {
              if (parseInt(cartItem.product_id) === productId) {
                productQuantity += cartItem.quantity;
              }
            });

            // Fetch product metafields directly via API using handle from URL
            const metafields = await fetchProductMetafields(productId, productInfo.url);
            
            if (!metafields || !metafields.discount || !metafields.discount_type) {
              continue;
            }
            
            // Parse discount codes and types from metafields
            const discountCodes = Array.isArray(metafields.discount) ? metafields.discount : [metafields.discount];
            const discountTypes = Array.isArray(metafields.discount_type) ? metafields.discount_type : [metafields.discount_type];

            // Check each coupon for this product
            for (let i = 0; i < discountCodes.length; i++) {
              try {
                const discountCode = discountCodes[i];
                const discountType = discountTypes[i] || '';
                
                if (!discountCode || discountCode === 'At checkout') continue;

                // Parse condition
                const parsedCondition = parseDiscountTypeToCondition(discountType);
                const shouldShow = await matchesDiscountCondition(discountType, productId);

                if (shouldShow && discountCode && discountCode !== 'At checkout') {
                  // Check if this coupon code already exists to avoid duplicates
                  const codeExists = allMatchingCoupons.some(c => c.code === discountCode);
                  
                  if (!codeExists) {
                    allMatchingCoupons.push({
                      code: discountCode,
                      condition: parsedCondition,
                      productId: productId
                    });
                  }

                  // Calculate score for selection (always check for best coupon, even if duplicate)
                  let score = 0;
                  if (parsedCondition) {
                    if (parsedCondition.type === 'price') {
                      score = parsedCondition.value * 1000;
                    } else if (parsedCondition.type === 'quantity') {
                      score = parsedCondition.value;
                    }
                  }

                  if (score > highestValue) {
                    highestValue = score;
                    bestCoupon = {
                      code: discountCode,
                      condition: parsedCondition
                    };
                  } else if (score === 0 && !bestCoupon) {
                    bestCoupon = {
                      code: discountCode,
                      condition: parsedCondition
                    };
                  }
                }
              } catch (error) {
                console.error('Error processing coupon:', error);
                continue;
              }
            }
          }

          // Set cookie for best matching coupon and store all matching coupons for fallback
          try {
            // Store all matching coupons in sessionStorage for fallback (remove duplicates)
            if (allMatchingCoupons.length > 0) {
              const couponCodes = allMatchingCoupons.map(c => c.code).filter(c => c && c !== 'At checkout');
              // Remove duplicates using Set
              const uniqueCouponCodes = [...new Set(couponCodes)];
              sessionStorage.setItem('all_matching_coupons', JSON.stringify(uniqueCouponCodes));
            } else {
              sessionStorage.removeItem('all_matching_coupons');
            }
            
            if (bestCoupon && bestCoupon.code) {
              setCookie('discount_code', bestCoupon.code, 30);
              // Apply discount to app discount block
              setTimeout(function() {
                if (typeof applyDiscountFromCookie === 'function') {
                  applyDiscountFromCookie();
                }
              }, 300);
            } else if (allMatchingCoupons.length > 0) {
              // Use first matching coupon
              setCookie('discount_code', allMatchingCoupons[0].code, 30);
              // Apply discount to app discount block
              setTimeout(function() {
                if (typeof applyDiscountFromCookie === 'function') {
                  applyDiscountFromCookie();
                }
              }, 300);
            } else {
              // No matching coupons
              setCookie('discount_code', '', -1);
            }
          } catch (error) {
            console.error('Error setting cookie:', error);
          }
        } catch (error) {
          console.error('Error in checkAllCartProductsCoupons:', error);
        }
      }

      /**
       * Initialize and check coupon conditions for product page
       * Only runs on product pages where discount coupons exist
       */
      let isCheckingCoupons = false;
      
      window.initCartQuantityCheck = async function initCartQuantityCheck() {
        // Prevent multiple simultaneous executions
        if (isCheckingCoupons) {
          return;
        }
        
        try {
          isCheckingCoupons = true;
          
          // On product page, check if discount section exists in DOM
          const discountSection = document.querySelector('.product-discount-coupons[data-product-id]');
          if (!discountSection) {
            // No discount section on this page, check all cart products via API
            checkAllCartProductsCoupons();
            return;
          }
          
          // Product page has discount section - use DOM directly (faster)
          // This is the same logic as before, but we'll also check cart products
          // to ensure we catch all products in cart, not just the current page product
          checkAllCartProductsCoupons();
          return;

          const productId = parseInt(discountSection.getAttribute('data-product-id'));
          if (!productId || isNaN(productId)) {
            return;
          }

          // Get cart data
          const cartData = await getProductQuantityFromCart(productId);
          const cartQuantity = cartData.quantity;
          const cartTotal = await getCartTotalPrice();

          const couponCards = discountSection.querySelectorAll('.discount-coupon-card[data-discount-type]');

          let bestCoupon = null;
          let highestValue = -1;
          let matchingCoupons = [];

          // Check each coupon
          for (let i = 0; i < couponCards.length; i++) {
            try {
              const card = couponCards[i];
              if (!card) continue;
              
              const discountType = card.getAttribute('data-discount-type');
              const discountCode = card.getAttribute('data-discount-code');
              
              if (!discountType) continue;
              
              // Parse condition
              const parsedCondition = parseDiscountTypeToCondition(discountType);
              const shouldShow = await matchesDiscountCondition(discountType, productId);

              // Show all coupons (no hiding, no visual changes)
              card.style.display = '';
              
              if (shouldShow) {
                // Check if this coupon code already exists to avoid duplicates
                const codeExists = matchingCoupons.some(c => c.code === discountCode);
                
                if (!codeExists) {
                  // Track matching coupons for cookie selection (no visual changes)
                  matchingCoupons.push({
                    card: card,
                    code: discountCode,
                    condition: parsedCondition
                  });
                }

                // Select coupon with highest requirement value for cookie
                // Priority: price-based > quantity-based > no condition
                let score = 0;
                if (parsedCondition) {
                  if (parsedCondition.type === 'price') {
                    score = parsedCondition.value * 1000; // Price gets higher priority
                  } else if (parsedCondition.type === 'quantity') {
                    score = parsedCondition.value;
                  }
                }
                
                if (score > highestValue) {
                  highestValue = score;
                  bestCoupon = {
                    card: card,
                    code: discountCode,
                    condition: parsedCondition
                  };
                } else if (score === 0 && !bestCoupon) {
                  // No condition coupon as fallback
                  bestCoupon = {
                    card: card,
                    code: discountCode,
                    condition: parsedCondition
                  };
                }
              }
            } catch (error) {
              console.error('Error processing coupon:', error);
              continue; // Continue with next coupon
            }
          }

          // Set cookie for best matching coupon and store all matching coupons for fallback
          try {
            // Store all matching coupons in sessionStorage for fallback (remove duplicates)
            if (matchingCoupons.length > 0) {
              const couponCodes = matchingCoupons.map(c => c.code).filter(c => c && c !== 'At checkout');
              // Remove duplicates using Set
              const uniqueCouponCodes = [...new Set(couponCodes)];
              sessionStorage.setItem('all_matching_coupons', JSON.stringify(uniqueCouponCodes));
            } else {
              sessionStorage.removeItem('all_matching_coupons');
            }
            
            if (bestCoupon && bestCoupon.code && bestCoupon.code !== 'At checkout') {
              // Set coupon code in cookie (no visual styling)
              setCookie('discount_code', bestCoupon.code, 30); // Cookie expires in 30 days
              
              // Apply discount to app discount block
              setTimeout(function() {
                if (typeof applyDiscountFromCookie === 'function') {
                  applyDiscountFromCookie();
                }
              }, 300);
            } else if (matchingCoupons.length > 0) {
              // If best coupon has no code, try to find first matching coupon with code
              for (let match of matchingCoupons) {
                if (match.code && match.code !== 'At checkout') {
                  setCookie('discount_code', match.code, 30);
                  // Apply discount to app discount block
                  setTimeout(function() {
                    if (typeof applyDiscountFromCookie === 'function') {
                      applyDiscountFromCookie();
                    }
                  }, 300);
                  break;
                }
              }
            } else {
              // No matching coupons, remove cookie
              setCookie('discount_code', '', -1); // Delete cookie
            }
          } catch (error) {
            console.error('Error setting cookie:', error);
          }
        } catch (error) {
          console.error('Error in initCartQuantityCheck:', error);
        } finally {
          isCheckingCoupons = false;
        }
      }

      // Initialize on page load with delay to ensure DOM is ready
      function initializeCouponCheck() {
        setTimeout(function() {
          try {
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                  initCartQuantityCheck();
                  checkAllCartProductsCoupons();
                }, 500);
              });
            } else {
              initCartQuantityCheck();
              checkAllCartProductsCoupons();
            }
          } catch (error) {
            console.error('Error initializing coupon check:', error);
          }
        }, 100);
      }
      
      initializeCouponCheck();

      // Re-check when cart is updated (debounced and with error handling)
      let cartUpdateTimeout;
      document.addEventListener('cart:updated', function() {
        try {
          clearTimeout(cartUpdateTimeout);
          cartUpdateTimeout = setTimeout(function() {
            initCartQuantityCheck();
            checkAllCartProductsCoupons();
          }, 500);
        } catch (error) {
              console.error('Error in cart:updated handler:', error);
            }
          });
          
          // Function to apply discount code from cookie to app discount block
          function applyDiscountFromCookie(couponCodeToTry) {
            try {
              // Get discount code from cookie or use provided code
              function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) {
                  return parts.pop().split(';').shift();
                }
                return '';
              }
              
              const discountCode = couponCodeToTry || getCookie('discount_code');
              
              if (!discountCode || discountCode.trim() === '') {
                return; // No discount code in cookie
              }
              
              // Find the discount block and input field
              const discountForm = document.querySelector('.dmp_discount-form');
              if (!discountForm) {
                return; // Discount form not found
              }
              
              const discountInput = discountForm.querySelector('input[name="temp-discount"]');
              const applyButton = discountForm.querySelector('button');
              
              if (!discountInput || !applyButton) {
                return; // Input or button not found
              }
              
              // Hide any error messages immediately
              const errorParent = document.querySelector('.dmp_error-parent');
              if (errorParent) {
                errorParent.style.display = 'none';
                errorParent.style.visibility = 'hidden';
                errorParent.style.opacity = '0';
              }
              
              // Set the discount code value
              discountInput.value = discountCode.trim();
              
              // Trigger input event to ensure app detects the change
              discountInput.dispatchEvent(new Event('input', { bubbles: true }));
              discountInput.dispatchEvent(new Event('change', { bubbles: true }));
              
              // Function to try next coupon if current one fails
              function tryNextCoupon(currentCode) {
                try {
                  const allCouponsStr = sessionStorage.getItem('all_matching_coupons');
                  if (allCouponsStr) {
                    const allCoupons = JSON.parse(allCouponsStr);
                    const currentIndex = allCoupons.indexOf(currentCode.trim());
                    if (currentIndex !== -1 && currentIndex < allCoupons.length - 1) {
                      // Try next coupon
                      const nextCoupon = allCoupons[currentIndex + 1];
                      if (nextCoupon) {
                        setCookie('discount_code', nextCoupon, 30);
                        setTimeout(() => {
                          applyDiscountFromCookie(nextCoupon);
                        }, 500);
                        return true;
                      }
                    }
                  }
                } catch (e) {
                  console.error('Error trying next coupon:', e);
                }
                return false;
              }
              
              // Watch for error messages using MutationObserver
              const errorObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                  if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                      if (node.nodeType === 1) {
                        const errorMessage = node.querySelector ? node.querySelector('.dmp_error-message') : null;
                        const isErrorNode = node.classList && node.classList.contains('dmp_error-message');
                        const errorMsg = errorMessage || (isErrorNode ? node : null);
                        
                        if (errorMsg && errorMsg.textContent && errorMsg.textContent.includes('not valid')) {
                          // Hide error immediately
                          const errorParent = errorMsg.closest('.dmp_error-parent');
                          if (errorParent) {
                            errorParent.style.display = 'none';
                            errorParent.style.visibility = 'hidden';
                            errorParent.style.opacity = '0';
                          }
                          
                          // Try next coupon
                          if (!tryNextCoupon(discountCode.trim())) {
                            errorObserver.disconnect();
                          }
                        }
                      }
                    });
                  }
                });
              });
              
              // Start observing for error messages
              const discountBlock = document.querySelector('.dmp_discount-block-preview');
              if (discountBlock) {
                errorObserver.observe(discountBlock, {
                  childList: true,
                  subtree: true,
                  characterData: true
                });
              }
              
              // Also observe document body in case error appears elsewhere
              errorObserver.observe(document.body, {
                childList: true,
                subtree: true
              });
              
              // Small delay before clicking apply button to ensure value is set
              setTimeout(() => {
                applyButton.click();
                
                // Also check for error after a delay (fallback)
                setTimeout(() => {
                  const errorMessage = document.querySelector('.dmp_error-message');
                  if (errorMessage && errorMessage.textContent && errorMessage.textContent.includes('not valid')) {
                    // Hide error immediately
                    const errorParent = errorMessage.closest('.dmp_error-parent');
                    if (errorParent) {
                      errorParent.style.display = 'none';
                      errorParent.style.visibility = 'hidden';
                      errorParent.style.opacity = '0';
                    }
                    
                    // Try next coupon
                    if (!tryNextCoupon(discountCode.trim())) {
                      errorObserver.disconnect();
                    }
                  } else {
                    // No error found, disconnect observer after a reasonable time
                    setTimeout(() => {
                      errorObserver.disconnect();
                    }, 2000);
                  }
                }, 1000);
              }, 100);
            } catch (error) {
              console.error('Error applying discount from cookie:', error);
            }
          }
          
          // Apply discount when discount block is added to DOM
          const discountObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach(function(node) {
                  if (node.nodeType === 1) { // Element node
                    // Check if discount block was added
                    if (node.classList && node.classList.contains('dmp_discount-block-preview')) {
                      setTimeout(applyDiscountFromCookie, 200);
                    }
                    // Check if discount form was added inside the node
                    if (node.querySelector && node.querySelector('.dmp_discount-form')) {
                      setTimeout(applyDiscountFromCookie, 200);
                    }
                  }
                });
              }
            });
          });
          
          // Observe document for discount block additions
          discountObserver.observe(document.body, {
            childList: true,
            subtree: true
          });
          
          // Also try to apply when cart updates
          document.addEventListener('cart:updated', function() {
            setTimeout(applyDiscountFromCookie, 500);
          });
          
          // Apply on page load if discount block already exists
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
              setTimeout(applyDiscountFromCookie, 500);
            });
          } else {
            setTimeout(applyDiscountFromCookie, 500);
          }
        </script>
    
    {%- comment -%} Floating WhatsApp Button {%- endcomment -%}
    <a 
      href="https://wa.me/919712318297?text=Hii,{{ request.origin | append: request.path | url_encode }}" 
      target="_blank" 
      rel="noopener noreferrer"
      class="whatsapp-float"
      aria-label="WhatsApp"
    >
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="#fff"/>
      </svg>
    </a>
    
    <style>
      .whatsapp-float {
        position: fixed;
        width: 40px;
        height: 40px;
        bottom: 84px;
        right: 41px;
        background-color: #000000;
        color: #fff;
        border-radius: 50px;
        text-align: center;
        font-size: 30px;
        box-shadow: 2px 2px 3px #999;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        text-decoration: none;
      }
      
      .whatsapp-float:hover {
        background-color: #000000 !important;
        transform: scale(1.1);
        box-shadow: 3px 3px 5px #666;
      }
      
      .whatsapp-float svg {
        width: 25px;
        height: 25px;
      }
      
      @media (max-width: 768px) {
        .whatsapp-float {
          width: 55px;
          height: 55px;
          bottom: 130px;
          right: 15px;
        }
        
        .whatsapp-float svg {
          width: 24px;
          height: 24px;
        }
      }
    </style>
  </body>
</html>
<style>
.pay-opt-icon img:first-child{
    margin-right: 10px;
    margin-left: 1px !important;
}

.side-cart-image{
  width:5rem !important;
}

.pb-30 {
    padding-bottom: 1rem !important;
}

.pt-30 {
    padding-top: 1.5rem !important;
}

/* Hide discount form on cart page, product page, and in minicart */
.dmp_discount-form {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    position: absolute !important;
    left: -9999px !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}

/* Hide discount error messages */
.dmp_error-parent,
.dmp_error-message {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
}
.custom-discount-box{
  flex-wrap: nowrap !important;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
}

@media (max-width: 991px) {
  .custom-discount-box {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>